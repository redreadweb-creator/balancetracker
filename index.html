<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BalanceTrack | Indian Business Party Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Excel Export Library -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #5856D6;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #FF9500;
            --dark: #1C1C1E;
            --light: #F2F2F7;
            --gray-100: #F2F2F7;
            --gray-200: #E5E5EA;
            --gray-300: #D1D1D6;
            --gray-400: #C7C7CC;
            --gray-500: #8E8E93;
            --gray-600: #636366;
            --gray-700: #48484A;
            --gray-800: #3A3A3C;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Mobile First Design */
        .mobile-header {
            display: none;
            background: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-200);
            backdrop-filter: blur(20px);
        }

        .mobile-header .logo {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--gray-200);
            display: none;
            justify-content: space-around;
            padding: 12px 0 calc(12px + env(safe-area-inset-bottom, 0));
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            background: none;
            color: var(--gray-500);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 11px;
            border-radius: var(--radius-md);
            width: 25%;
            min-width: 0;
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        .nav-item i {
            font-size: 18px;
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity var(--transition-medium);
        }

        .loading-overlay.active {
            display: flex;
            opacity: 1;
            animation: fadeIn var(--transition-medium);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 16px;
            z-index: 9998;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: white;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform var(--transition-medium), opacity var(--transition-medium);
            opacity: 0;
            border-left: 4px solid var(--primary);
            max-width: 320px;
            word-break: break-word;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        .toast-icon {
            font-size: 18px;
            min-width: 20px;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast.info .toast-icon {
            color: var(--primary);
        }

        .toast-content {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            margin-left: 8px;
        }

        /* Authentication */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: gradientShift 15s ease infinite;
            background-size: 400% 400%;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-sm);
            font-size: 15px;
            min-height: 44px;
        }

        .auth-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 16px;
            transition: all var(--transition-fast);
            background: white;
            min-height: 48px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* Enhanced Party Suggestion Dropdown */
        .suggestion-container {
            position: relative;
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 4px;
            border: 1px solid var(--gray-200);
        }

        .suggestions-list.show {
            display: block;
        }

        .suggestion-item {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--gray-100);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            font-size: 16px;
        }

        .suggestion-type {
            font-size: 14px;
            color: var(--gray-500);
        }

        /* Currency Display */
        .currency-display {
            display: inline-flex;
            align-items: center;
        }

        .currency-display::before {
            content: "₹";
            margin-right: 4px;
            font-weight: 600;
        }

        .currency-input .form-control {
            padding-left: 40px;
        }

        .currency-input::before {
            content: "₹";
            position: absolute;
            left: 16px;
            top: 42px;
            font-weight: 600;
            color: var(--gray-700);
            z-index: 2;
            font-size: 18px;
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
            min-height: 48px;
            width: 100%;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #cc0000;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Main App Layout */
        .app-container {
            display: none;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--gray-200);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            transition: transform var(--transition-fast);
        }

        .logo:hover {
            transform: scale(1.02);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 16px;
            animation: fadeInContent 0.4s ease;
            padding-bottom: 80px;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dashboard Grid - Fixed for Mobile */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all var(--transition-medium);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .stat-card:active {
            transform: translateY(-2px) scale(1.01);
        }

        .stat-card:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .stat-card.debtors {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }

        .stat-card.creditors {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
        }

        .stat-card.total-parties {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
        }

        .stat-card.net-position {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-title {
            font-size: 13px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        /* Quick Actions - Fixed for Mobile */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 16px;
            border-radius: var(--radius-md);
            background: white;
            border: 2px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: 600;
            font-size: 14px;
            min-height: 100px;
            justify-content: center;
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .action-btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .action-btn:active {
            transform: translateY(0);
        }

        /* Parties Table - Fixed for Mobile */
        .parties-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeInContent 0.5s ease;
            margin-bottom: 20px;
        }

        .parties-header {
            padding: 20px 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .parties-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .search-box {
            padding: 14px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            width: 100%;
            font-size: 16px;
            transition: all var(--transition-fast);
        }

        .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: var(--gray-100);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-600);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
            transition: background-color var(--transition-fast);
        }

        tbody tr {
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        tbody tr:hover {
            background: var(--gray-100);
        }

        tbody tr:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: -2px;
        }

        tbody tr:active {
            background: var(--gray-200);
        }

        .currency-cell {
            font-weight: 700;
            font-size: 16px;
            text-align: right;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Courier New', monospace;
            direction: ltr;
        }

        /* FIXED: Always show creditors in red, debtors in green, zero in gray */
        .balance-debtor,
        .balance-positive {
            color: var(--success) !important;
        }

        .balance-creditor,
        .balance-negative {
            color: var(--danger) !important;
        }

        .balance-zero {
            color: var(--gray-500) !important;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .status-inactive {
            background: rgba(142, 142, 147, 0.1);
            color: var(--gray-500);
        }

        /* Party Type Badges */
        .party-type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .party-type-debtor {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .party-type-creditor {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Action Buttons - Fixed for Mobile */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 2px solid var(--gray-200);
            background: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .action-icon:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .action-icon:active {
            transform: scale(0.95);
        }

        .action-icon.view:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .action-icon.edit:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .action-icon.delete:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Party Details Page - Fixed for Mobile */
        .party-details-page {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeInContent 0.4s ease;
            margin-bottom: 80px;
        }

        .party-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 24px 16px;
            position: relative;
            overflow: hidden;
        }

        .party-header-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.1);
        }

        .party-header-back:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-4px);
        }

        .party-header-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }

        .party-header-info h1 {
            font-size: 28px;
            margin-bottom: 12px;
            font-weight: 700;
            line-height: 1.2;
            word-break: break-word;
        }

        .party-header-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .party-header-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .party-stat {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .party-stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .party-stat-value {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
        }

        /* Party Content */
        .party-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px 16px;
        }

        /* Transactions - Fixed for Mobile */
        .transactions-section {
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            padding: 20px 16px;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-200);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .transaction-item {
            background: white;
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow);
            transition: all var(--transition-fast);
            border-left: 4px solid transparent;
            position: relative;
            cursor: pointer;
        }

        .transaction-item:active {
            transform: scale(0.98);
        }

        .transaction-item.credit {
            border-left-color: var(--success);
        }

        .transaction-item.debit {
            border-left-color: var(--danger);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .transaction-date {
            font-size: 13px;
            color: var(--gray-500);
        }

        .transaction-type {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .transaction-type.credit {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .transaction-type.debit {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .transaction-description {
            margin-bottom: 12px;
            color: var(--gray-700);
            line-height: 1.5;
            font-size: 15px;
            word-break: break-word;
        }

        .transaction-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 8px;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Courier New', monospace;
            direction: ltr;
        }

        .transaction-balance {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Courier New', monospace;
            direction: ltr;
        }

        /* Party Info Sidebar */
        .party-info-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            padding: 20px 16px;
            border: 1px solid var(--gray-200);
        }

        .info-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
            gap: 8px;
        }

        .info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .info-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
            min-width: 100px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            text-align: right;
            word-break: break-word;
            flex: 1;
        }

        /* Modal System - Fixed for Mobile */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn var(--transition-medium);
            padding: 16px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            margin: auto;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-200);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .modal-close {
            background: var(--gray-100);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-600);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .modal-close:active {
            transform: scale(0.95);
        }

        /* Form Layout */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Confirmation Modal */
        .confirmation-modal .modal {
            max-width: 400px;
            text-align: center;
        }

        .confirmation-content {
            padding: 20px 0;
        }

        .confirmation-icon {
            font-size: 48px;
            color: var(--danger);
            margin-bottom: 20px;
        }

        .confirmation-text {
            margin-bottom: 24px;
            color: var(--gray-700);
            font-size: 16px;
            line-height: 1.6;
        }

        .confirmation-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Graphs Container - FIXED with scrollable charts */
        .graphs-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            animation: fadeInContent 0.5s ease;
            overflow: hidden;
        }

        .filters-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* FIXED: Chart container with horizontal scroll */
        .chart-container {
            background: white;
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
            position: relative;
        }

        .chart-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
            margin: 0 -10px;
            padding: 0 10px;
        }

        .chart-inner {
            min-width: 600px;
            position: relative;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            padding-bottom: 10px;
        }

        /* Print Container - FIXED horizontal layout */
        .print-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            animation: fadeInContent 0.5s ease;
        }

        .print-preview {
            background: var(--gray-100);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-top: 24px;
            border: 1px solid var(--gray-300);
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            page-break-inside: avoid;
            overflow-x: auto;
        }

        .print-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-300);
        }

        .print-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .print-subtitle {
            font-size: 14px;
            color: var(--gray-600);
            line-height: 1.4;
        }

        .print-section {
            margin-bottom: 24px;
            page-break-inside: avoid;
            overflow-x: auto;
        }

        .print-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-300);
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Courier New', monospace;
            min-width: 600px;
        }

        .print-table th {
            background: var(--gray-200);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            white-space: nowrap;
        }

        .print-table td {
            padding: 12px;
            border: 1px solid var(--gray-300);
            word-break: break-word;
        }

        .print-table .currency-column {
            text-align: right;
            direction: ltr;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Courier New', monospace;
            white-space: nowrap;
        }

        .print-total-row {
            background: var(--gray-200);
            font-weight: bold;
            border-top: 2px solid var(--gray-400);
        }

        /* FIXED: Print summary stays horizontal on mobile */
        .print-summary {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 2px solid var(--gray-300);
            page-break-inside: avoid;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .print-summary-item {
            background: var(--gray-100);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-300);
            min-width: 180px;
            flex-shrink: 0;
        }

        .print-summary-label {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .print-summary-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Courier New', monospace;
            direction: ltr;
            white-space: nowrap;
        }

        .print-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        /* Focus States */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 16px;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Party Type Tabs */
        .party-type-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .party-type-tabs::-webkit-scrollbar {
            display: none;
        }

        .party-type-tab {
            padding: 12px 20px;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: all var(--transition-fast);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            min-height: 44px;
        }

        .party-type-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .party-type-tab:active {
            transform: scale(0.98);
        }

        /* Responsive Media Queries - IMPROVED for Mobile */
        @media (max-width: 768px) {
            .app-header {
                display: none;
            }
            
            .mobile-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .mobile-nav {
                display: flex;
            }
            
            .header-content {
                padding: 0 16px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .main-content {
                padding-top: 12px;
                padding-bottom: 100px;
            }
            
            .stat-value {
                font-size: 22px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .action-btn {
                min-height: 80px;
            }
            
            .transaction-amount {
                font-size: 16px;
            }
            
            .transaction-balance {
                font-size: 13px;
            }
            
            .party-stat-value {
                font-size: 18px;
            }
            
            .party-header-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .party-stat {
                padding: 12px;
            }
            
            .form-control {
                font-size: 16px;
                padding: 14px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
            
            .modal {
                padding: 20px 16px;
                max-height: 85vh;
            }
            
            .toast-container {
                top: 16px;
                right: 8px;
                left: 8px;
                max-width: calc(100% - 16px);
            }
            
            .toast {
                max-width: 100%;
                padding: 10px 14px;
            }
            
            .print-preview {
                padding: 16px;
            }
            
            .print-table {
                font-size: 12px;
            }
            
            .print-table th,
            .print-table td {
                padding: 8px;
            }
            
            /* FIXED: Print summary scrolls horizontally instead of wrapping */
            .print-summary {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 8px;
                padding-bottom: 10px;
            }
            
            .print-summary-item {
                min-width: 160px;
                padding: 12px;
            }
            
            .print-summary-value {
                font-size: 16px;
            }
            
            .filters-container {
                padding: 16px;
            }
            
            .chart-container {
                padding: 16px;
            }
            
            .chart-inner {
                min-width: 500px;
            }
            
            /* Fix action buttons in table */
            .action-buttons {
                gap: 4px;
            }
            
            .action-icon {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            /* Fix party header actions */
            .party-header-actions {
                grid-template-columns: 1fr;
            }
            
            /* Fix party info items */
            .info-item {
                flex-direction: row;
                align-items: center;
                gap: 4px;
            }
            
            .info-label {
                min-width: auto;
                font-size: 13px;
                white-space: nowrap;
            }
            
            .info-value {
                text-align: right;
                font-size: 13px;
                white-space: nowrap;
            }
        }

        @media (min-width: 480px) and (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr 1fr;
            }
            
            .party-header-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .print-summary-item {
                min-width: 140px;
            }
            
            .chart-inner {
                min-width: 550px;
            }
        }

        @media (min-width: 769px) {
            .mobile-header,
            .mobile-nav {
                display: none;
            }
            
            .app-header {
                display: block;
            }
            
            .main-content {
                padding-bottom: 32px;
            }
            
            .party-details-page {
                margin-bottom: 32px;
            }
            
            .action-btn {
                flex-direction: row;
                min-height: auto;
                height: auto;
            }
            
            .party-type-tabs {
                flex-wrap: wrap;
                overflow-x: visible;
            }
            
            .form-row {
                flex-direction: row;
            }
            
            .form-row > .form-group {
                flex: 1;
            }
            
            .btn {
                width: auto;
            }
            
            .confirmation-buttons {
                flex-direction: row;
            }
            
            .party-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
            }
            
            .filters-container {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .party-header-actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .chart-scroll-wrapper {
                overflow-x: visible;
                padding: 0;
                margin: 0;
            }
            
            .chart-inner {
                min-width: auto;
            }
            
            .print-summary {
                flex-wrap: wrap;
                overflow-x: visible;
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .action-btn {
                min-width: 180px;
            }
        }

        /* Print specific styles */
        @media print {
            .print-preview {
                padding: 0;
                margin: 0;
                border: none;
                background: white;
                max-width: 100%;
                overflow-x: visible;
            }
            
            .print-actions,
            .mobile-nav,
            .mobile-header,
            .app-header,
            .toast-container {
                display: none !important;
            }
            
            .print-table {
                font-size: 11px;
            }
            
            .print-table th,
            .print-table td {
                padding: 6px;
            }
            
            .print-summary {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: visible !important;
                gap: 10px;
            }
            
            body {
                background: white;
            }
            
            .main-content {
                padding: 0;
                margin: 0;
            }
            
            .print-container {
                box-shadow: none;
                padding: 0;
            }
            
            /* Remove ₹ symbol from print */
            .currency-display::before,
            .currency-cell::before,
            .print-summary-value::before,
            .print-table .currency-column::before,
            .transaction-amount::before,
            .transaction-balance::before,
            .stat-value::before,
            .party-stat-value::before {
                content: "" !important;
                display: none !important;
            }
            
            /* Remove color from print */
            .balance-debtor,
            .balance-creditor,
            .balance-zero,
            .transaction-amount,
            .transaction-balance,
            .print-summary-value {
                color: black !important;
            }
        }

        /* Safe Area Insets */
        @supports (padding: max(0px)) {
            body, .mobile-nav {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            .mobile-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .toast-container {
                top: calc(16px + env(safe-area-inset-top, 0px));
            }
            
            .main-content {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
        }

        /* Keyboard Navigation Help */
        .keyboard-help {
            position: fixed;
            bottom: 100px;
            right: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            display: none;
            z-index: 100;
            animation: slideUp 0.3s ease;
        }

        .keyboard-help.show {
            display: block;
        }

        /* Haptic Feedback for Mobile */
        @media (hover: none) and (pointer: coarse) {
            .btn:active,
            .action-btn:active,
            .action-icon:active,
            .party-type-tab:active,
            .transaction-item:active {
                transform: scale(0.98);
            }
        }
        
        /* NEW: PDF print simulation container */
        .pdf-print-container {
            position: fixed;
            top: -10000px;
            left: -10000px;
            width: 210mm;
            height: 297mm;
            padding: 20mm;
            background: white;
            color: black;
            font-size: 11pt;
            font-family: Arial, sans-serif;
            z-index: -10000;
            opacity: 0;
        }
        
        /* UPDATED: Better chart container styling for horizontal bar chart */
        .apexcharts-canvas {
            width: 100% !important;
        }
        
        /* UPDATED: Better horizontal bar chart label styling */
        .apexcharts-yaxis-label {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        /* UPDATED: Better horizontal bar chart value labels */
        .apexcharts-datalabels {
            font-weight: 600;
            font-size: 12px;
        }
        
        /* UPDATED: Hide unnecessary scrollbar in desktop */
        @media (min-width: 769px) {
            .chart-scroll-wrapper::-webkit-scrollbar {
                display: none;
            }
            .chart-scroll-wrapper {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
        
        /* NEW: Custom chart styles for better horizontal layout */
        .horizontal-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-labels-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 10px;
            font-size: 12px;
            color: var(--gray-600);
        }
        
        .chart-bars-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chart-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }
        
        .chart-party-name {
            flex: 0 0 200px;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chart-bar-track {
            flex: 1;
            height: 30px;
            background: var(--gray-200);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .chart-bar-fill {
            height: 100%;
            border-radius: 15px;
            position: relative;
            transition: width 0.5s ease;
        }
        
        .chart-bar-fill.debtor {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .chart-bar-fill.creditor {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .chart-bar-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .chart-party-balance {
            flex: 0 0 120px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', monospace;
            direction: ltr;
        }
        
        .chart-party-balance.debtor {
            color: var(--success);
        }
        
        .chart-party-balance.creditor {
            color: var(--danger);
        }
        
        .chart-party-type {
            flex: 0 0 80px;
            text-align: center;
        }
        
        .chart-party-type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .chart-party-type-badge.debtor {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .chart-party-type-badge.creditor {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Keyboard Navigation Help -->
    <div class="keyboard-help" id="keyboardHelp">
        <div><strong>Tab</strong> - Navigate between elements</div>
        <div><strong>Enter</strong> - Select/Submit</div>
        <div><strong>Escape</strong> - Close modal</div>
    </div>

    <!-- NEW: Hidden PDF print container -->
    <div class="pdf-print-container" id="pdfPrintContainer"></div>

    <!-- Authentication Screen -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login" id="loginTab">Sign In</button>
                <button class="auth-tab" data-tab="signup" id="signupTab">Sign Up</button>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email</label>
                    <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </button>
            </div>

            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="signupName">Full Name</label>
                    <input type="text" class="form-control" id="signupName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupEmail">Email</label>
                    <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPassword">Password</label>
                    <input type="password" class="form-control" id="signupPassword" placeholder="Create a password">
                </div>
                <button class="btn btn-primary" id="signupBtn">
                    <i class="fas fa-user-plus"></i>
                    <span>Create Account</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Desktop Header -->
        <header class="app-header">
            <div class="header-content">
                <a href="#" class="logo" onclick="showDashboard()">
                    <i class="fas fa-balance-scale"></i>
                    BalanceTrack
                </a>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <button class="btn btn-outline" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="logo">
                <i class="fas fa-balance-scale"></i>
                BalanceTrack
            </div>
            <div class="user-avatar" id="mobileUserAvatar">JD</div>
        </div>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard content will be loaded here -->
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <button class="nav-item active" onclick="showDashboard()">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" onclick="showGraphs()">
                <i class="fas fa-chart-line"></i>
                <span>Graphs</span>
            </button>
            <button class="nav-item" onclick="showPrint()">
                <i class="fas fa-print"></i>
                <span>Print</span>
            </button>
            <button class="nav-item" onclick="openPartyModal()">
                <i class="fas fa-user-plus"></i>
                <span>Add Party</span>
            </button>
        </nav>
    </div>

    <!-- Add Party Modal -->
    <div class="modal-overlay" id="partyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="partyModalTitle">Add New Party</div>
                <button class="modal-close" id="closePartyModal">&times;</button>
            </div>
            <form id="partyForm">
                <div class="form-group">
                    <label class="form-label" for="partyName">Party Name *</label>
                    <input type="text" class="form-control" id="partyName" required autocomplete="off">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="partyType">Type</label>
                        <select class="form-control" id="partyType">
                            <option value="sundry_debtors">Sundry Debtor (Customer)</option>
                            <option value="sundry_creditors">Sundry Creditor (Supplier)</option>
                        </select>
                    </div>
                    <div class="form-group currency-input">
                        <label class="form-label" for="initialBalance">Initial Balance</label>
                        <input type="number" class="form-control" id="initialBalance" step="0.01" value="0" autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="partyGSTIN">GSTIN (Optional)</label>
                    <input type="text" class="form-control" id="partyGSTIN" placeholder="Enter GSTIN number" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label" for="partyAddress">Address</label>
                    <textarea class="form-control" id="partyAddress" rows="2" placeholder="Enter complete address" autocomplete="off"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="partyEmail">Contact Email</label>
                        <input type="email" class="form-control" id="partyEmail" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="partyPhone">Phone Number</label>
                        <input type="tel" class="form-control" id="partyPhone" autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="partyNotes">Notes</label>
                    <textarea class="form-control" id="partyNotes" rows="3" autocomplete="off"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-direction: column;">
                    <button type="submit" class="btn btn-primary" id="savePartyBtn">
                        Save Party
                    </button>
                    <button type="button" class="btn btn-outline" id="cancelPartyForm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="transactionModalTitle">Add Transaction</div>
                <button class="modal-close" id="closeTransactionModal">&times;</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group suggestion-container">
                    <label class="form-label" for="transactionParty">Party *</label>
                    <input type="text" class="form-control" id="transactionPartySearch" placeholder="Type to search parties..." autocomplete="off">
                    <input type="hidden" id="transactionParty">
                    <div class="suggestions-list" id="partySuggestions"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="transactionDate">Date *</label>
                        <input type="date" class="form-control" id="transactionDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="transactionType">Type *</label>
                        <select class="form-control" id="transactionType" required>
                            <option value="credit">Credit (Money In)</option>
                            <option value="debit">Debit (Money Out)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group currency-input">
                    <label class="form-label" for="transactionAmount">Amount *</label>
                    <input type="number" class="form-control" id="transactionAmount" step="0.01" min="0.01" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label" for="paymentMode">Payment Mode</label>
                    <select class="form-control" id="paymentMode">
                        <option value="cash">Cash</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                        <option value="upi">UPI</option>
                        <option value="card">Card</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="transactionDescription">Description</label>
                    <input type="text" class="form-control" id="transactionDescription" placeholder="Enter transaction description" autocomplete="off">
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-direction: column;">
                    <button type="submit" class="btn btn-primary" id="saveTransactionBtn">
                        Save Transaction
                    </button>
                    <button type="button" class="btn btn-outline" id="cancelTransactionForm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay confirmation-modal" id="confirmationModal">
        <div class="modal">
            <div class="confirmation-content">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 id="confirmationTitle">Confirm Action</h3>
                <p class="confirmation-text" id="confirmationText">Are you sure you want to proceed?</p>
                <div class="confirmation-buttons">
                    <button type="button" class="btn btn-outline" id="cancelConfirmation">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmAction">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://pobwgbyfrzuudpiwykki.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvYndnYnlmcnp1dWRwaXd5a2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNDg2MzQsImV4cCI6MjA4MjgyNDYzNH0.5jhwqCDXqNTRGW8PdHkW-niyVOvyK37NaaY49YHkyF0';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State Management
        let currentUser = null;
        let parties = [];
        let transactions = [];
        let currentParty = null;
        let currentPartyTransactions = [];
        let pendingAction = null;
        let selectedRowIndex = -1;
        let selectedTransactionIndex = -1;
        let currentFocusedElement = null;
        let currentFormElements = [];
        let currentFormIndex = -1;
        let charts = {};
        let currentReportType = 'party-summary';

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const mainContent = document.getElementById('mainContent');
        const toastContainer = document.getElementById('toastContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const keyboardHelp = document.getElementById('keyboardHelp');
        const pdfPrintContainer = document.getElementById('pdfPrintContainer');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
            setupKeyboardNavigation();
            setupPartySearch();
        });

        // Setup party search and suggestions
        function setupPartySearch() {
            const searchInput = document.getElementById('transactionPartySearch');
            const suggestionsList = document.getElementById('partySuggestions');
            const hiddenInput = document.getElementById('transactionParty');
            const typeSelect = document.getElementById('transactionType');

            if (!searchInput) return;

            let selectedIndex = -1;
            let suggestions = [];

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                suggestions = [];
                selectedIndex = -1;

                if (query.length < 1) {
                    suggestionsList.classList.remove('show');
                    hiddenInput.value = '';
                    return;
                }

                // Filter parties based on search query
                suggestions = parties.filter(party => 
                    party.name.toLowerCase().includes(query) ||
                    party.email?.toLowerCase().includes(query) ||
                    party.phone?.includes(query)
                ).slice(0, 5); // Limit to 5 suggestions for mobile

                if (suggestions.length > 0) {
                    renderSuggestions(suggestions);
                    suggestionsList.classList.add('show');
                } else {
                    suggestionsList.classList.remove('show');
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                const items = suggestionsList.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelection();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    selectSuggestion(suggestions[selectedIndex]);
                } else if (e.key === 'Escape') {
                    suggestionsList.classList.remove('show');
                }
            });

            function renderSuggestions(suggestions) {
                suggestionsList.innerHTML = suggestions.map((party, index) => `
                    <div class="suggestion-item ${index === selectedIndex ? 'selected' : ''}" 
                         data-index="${index}"
                         onclick="selectSuggestion(${JSON.stringify(party).replace(/"/g, '&quot;')})">
                        <div class="suggestion-name">${party.name}</div>
                        <div class="suggestion-type">
                            ${party.type === 'sundry_debtors' ? 'Debtor' : 'Creditor'}
                            <span class="currency-display">${formatCurrency(party.balance || 0)}</span>
                        </div>
                    </div>
                `).join('');
            }

            function updateSelection() {
                const items = suggestionsList.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                    if (index === selectedIndex) {
                        item.scrollIntoView({ block: 'nearest' });
                    }
                });
            }

            window.selectSuggestion = function(party) {
                searchInput.value = party.name;
                hiddenInput.value = party.id;
                suggestionsList.classList.remove('show');
                
                // Set intelligent default transaction type
                if (party.type === 'sundry_debtors') {
                    typeSelect.value = 'credit';
                } else {
                    typeSelect.value = 'debit';
                }
                
                // Move focus to next field
                document.getElementById('transactionAmount').focus();
            };

            // Close suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.classList.remove('show');
                }
            });
        }

        // Setup keyboard navigation
        function setupKeyboardNavigation() {
            let helpTimer;
            
            // Show keyboard help on Alt+K
            document.addEventListener('keydown', (e) => {
                if (e.altKey && e.key === 'k') {
                    keyboardHelp.classList.add('show');
                    clearTimeout(helpTimer);
                    helpTimer = setTimeout(() => {
                        keyboardHelp.classList.remove('show');
                    }, 3000);
                }
                
                // Close keyboard help on Escape
                if (e.key === 'Escape') {
                    keyboardHelp.classList.remove('show');
                }
            });
        }

        // Check authentication status
        async function checkAuth() {
            showLoading();
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session?.user) {
                currentUser = session.user;
                await initializeApp();
            } else {
                hideLoading();
                authContainer.style.display = 'flex';
                document.getElementById('loginEmail').focus();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth tab switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.tab === 'login') {
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('signupForm').style.display = 'none';
                        document.getElementById('loginEmail').focus();
                    } else {
                        document.getElementById('loginForm').style.display = 'none';
                        document.getElementById('signupForm').style.display = 'block';
                        document.getElementById('signupName').focus();
                    }
                });
            });

            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Signup
            document.getElementById('signupBtn').addEventListener('click', handleSignup);
            document.getElementById('signupPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSignup();
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Modals
            document.getElementById('closePartyModal').addEventListener('click', () => closeModal('party'));
            document.getElementById('closeTransactionModal').addEventListener('click', () => closeModal('transaction'));
            document.getElementById('cancelPartyForm').addEventListener('click', () => closeModal('party'));
            document.getElementById('cancelTransactionForm').addEventListener('click', () => closeModal('transaction'));
            document.getElementById('cancelConfirmation').addEventListener('click', () => closeModal('confirmation'));
            document.getElementById('confirmAction').addEventListener('click', handleConfirmation);

            // Forms
            document.getElementById('partyForm').addEventListener('submit', handlePartySubmit);
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);

            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('partyModal').classList.contains('active')) {
                        closeModal('party');
                    } else if (document.getElementById('transactionModal').classList.contains('active')) {
                        closeModal('transaction');
                    } else if (document.getElementById('confirmationModal').classList.contains('active')) {
                        closeModal('confirmation');
                    }
                }
            });

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            showLoading();
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Signing in...</span>';

            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                showToast(error.message, 'error');
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>Sign In</span>';
                hideLoading();
            } else {
                currentUser = data.user;
                await initializeApp();
            }
        }

        // Handle signup
        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();

            if (!name || !email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            showLoading();
            const signupBtn = document.getElementById('signupBtn');
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Creating account...</span>';

            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: name
                    }
                }
            });

            if (error) {
                showToast(error.message, 'error');
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<i class="fas fa-user-plus"></i><span>Create Account</span>';
                hideLoading();
            } else {
                showToast('Account created successfully! Please check your email to verify your account.', 'success');
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<i class="fas fa-user-plus"></i><span>Create Account</span>';
                hideLoading();
                
                // Switch to login tab
                document.querySelector('.auth-tab').click();
                document.getElementById('signupName').value = '';
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
            }
        }

        // Handle logout
        async function handleLogout() {
            showLoading();
            await supabase.auth.signOut();
            currentUser = null;
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            hideLoading();
            document.getElementById('loginEmail').focus();
        }

        // Initialize the main application
        async function initializeApp() {
            showLoading();
            
            try {
                // Set user avatar
                const avatarText = currentUser.email.substring(0, 2).toUpperCase();
                document.getElementById('userAvatar').textContent = avatarText;
                document.getElementById('mobileUserAvatar').textContent = avatarText;
                
                // Load data
                await Promise.all([
                    loadParties(),
                    loadTransactions()
                ]);
                
                // Show dashboard
                showDashboard();
                
                // Show app with animation
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Setup real-time subscription
                setupRealtimeSubscription();
                
            } catch (error) {
                showToast('Failed to load data: ' + error.message, 'error');
                console.error('Initialization error:', error);
            }
            
            hideLoading();
        }

        // Load parties from Supabase
        async function loadParties() {
            const { data, error } = await supabase
                .from('parties')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('name');
            
            if (error) throw error;
            parties = data || [];
        }

        // Load transactions from Supabase
        async function loadTransactions() {
            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });
            
            if (error) throw error;
            transactions = data || [];
        }

        // Load transactions for a specific party
        async function loadPartyTransactions(partyId) {
            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('party_id', partyId)
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });
            
            if (error) throw error;
            currentPartyTransactions = data || [];
            return currentPartyTransactions;
        }

        // Show dashboard
        async function showDashboard() {
            showLoading();
            currentParty = null;
            selectedRowIndex = -1;
            
            try {
                // Calculate stats
                const sundryDebtors = parties.filter(p => p.type === 'sundry_debtors');
                const sundryCreditors = parties.filter(p => p.type === 'sundry_creditors');
                
                const debtorsBalance = sundryDebtors.reduce((sum, p) => sum + (p.balance || 0), 0);
                const creditorsBalance = sundryCreditors.reduce((sum, p) => sum + (p.balance || 0), 0);
                const netPosition = debtorsBalance - Math.abs(creditorsBalance);
                
                // Update mobile nav
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                
                // Build dashboard HTML
                const html = `
                    <div class="quick-actions">
                        <button class="action-btn" onclick="openPartyModal()" tabindex="0">
                            <i class="fas fa-user-plus"></i>
                            <span>Add Party</span>
                        </button>
                        <button class="action-btn" onclick="openTransactionModal()" tabindex="0">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Add Transaction</span>
                        </button>
                        <button class="action-btn" onclick="showGraphs()" tabindex="0">
                            <i class="fas fa-chart-line"></i>
                            <span>View Graphs</span>
                        </button>
                        <button class="action-btn" onclick="showPrint()" tabindex="0">
                            <i class="fas fa-print"></i>
                            <span>Print Report</span>
                        </button>
                    </div>

                    <div class="dashboard-grid">
                        <div class="stat-card debtors" onclick="showDebtors()" tabindex="0">
                            <div class="stat-header">
                                <div class="stat-title">Sundry Debtors</div>
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="stat-value currency-display">${formatCurrency(debtorsBalance)}</div>
                            <div class="stat-change">
                                <i class="fas fa-users"></i>
                                ${sundryDebtors.length} parties
                            </div>
                        </div>
                        <div class="stat-card creditors" onclick="showCreditors()" tabindex="0">
                            <div class="stat-header">
                                <div class="stat-title">Sundry Creditors</div>
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-value currency-display">${formatCurrency(creditorsBalance)}</div>
                            <div class="stat-change">
                                <i class="fas fa-users"></i>
                                ${sundryCreditors.length} parties
                            </div>
                        </div>
                        <div class="stat-card total-parties" onclick="showAllParties()" tabindex="0">
                            <div class="stat-header">
                                <div class="stat-title">Total Parties</div>
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value">${parties.length}</div>
                            <div class="stat-change">
                                <i class="fas fa-chart-line"></i>
                                All parties
                            </div>
                        </div>
                        <div class="stat-card net-position" onclick="showDashboard()" tabindex="0">
                            <div class="stat-header">
                                <div class="stat-title">Net Position</div>
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="stat-value currency-display">${formatCurrency(netPosition)}</div>
                            <div class="stat-change">
                                <i class="fas fa-${netPosition >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                                ${netPosition >= 0 ? 'Net receivable' : 'Net payable'}
                            </div>
                        </div>
                    </div>

                    <div class="party-type-tabs">
                        <button class="party-type-tab active" onclick="filterPartiesByType('all')" tabindex="0">
                            <i class="fas fa-users"></i> All Parties
                        </button>
                        <button class="party-type-tab" onclick="filterPartiesByType('sundry_debtors')" tabindex="0">
                            <i class="fas fa-user-tie"></i> Sundry Debtors
                        </button>
                        <button class="party-type-tab" onclick="filterPartiesByType('sundry_creditors')" tabindex="0">
                            <i class="fas fa-building"></i> Sundry Creditors
                        </button>
                    </div>

                    <div class="parties-container">
                        <div class="parties-header">
                            <div class="parties-title">Parties & Balances</div>
                            <input type="text" class="search-box" id="partySearch" placeholder="Search parties..." oninput="filterParties()" tabindex="0">
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th style="text-align: right;">Current Balance</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="partiesTableBody">
                                    ${renderPartiesTable()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                mainContent.innerHTML = html;
                
                // Setup party search for transaction modal
                setupPartySearch();
                
            } catch (error) {
                showToast('Failed to load dashboard: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        // Show graphs/analytics
        async function showGraphs() {
            showLoading();
            
            try {
                // Update mobile nav
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                
                // Calculate date range for last 30 days
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                const html = `
                    <div class="graphs-container">
                        <h1 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--dark);">
                            <i class="fas fa-chart-line"></i> Analytics & Graphs
                        </h1>
                        
                        <div class="filters-container">
                            <div class="filter-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="graphStartDate" value="${startDate.toISOString().split('T')[0]}">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="graphEndDate" value="${endDate.toISOString().split('T')[0]}">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Party Type</label>
                                <select class="form-control" id="graphPartyType">
                                    <option value="all">All Parties</option>
                                    <option value="sundry_debtors">Sundry Debtors Only</option>
                                    <option value="sundry_creditors">Sundry Creditors Only</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Party</label>
                                <select class="form-control" id="graphParty">
                                    <option value="all">All Parties</option>
                                    ${parties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-primary" onclick="updateGraphs()" tabindex="0" style="margin-top: 8px;">
                                    <i class="fas fa-sync-alt"></i> Update Graphs
                                </button>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i> Balance Distribution
                            </div>
                            <div class="chart-scroll-wrapper">
                                <div class="chart-inner">
                                    <div id="balanceChart" style="min-height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-bar"></i> Transaction Trends
                            </div>
                            <div class="chart-scroll-wrapper">
                                <div class="chart-inner">
                                    <div id="transactionChart" style="min-height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-area"></i> Party Balances
                            </div>
                            <div class="chart-scroll-wrapper">
                                <div class="chart-inner">
                                    <div id="partyChart" style="min-height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                mainContent.innerHTML = html;
                
                // Initialize charts
                setTimeout(() => {
                    updateGraphs();
                }, 100);
                
            } catch (error) {
                showToast('Failed to load graphs: ' + error.message, 'error');
                console.error('Graphs error:', error);
            }
            
            hideLoading();
        }

        // Update graphs based on filters - UPDATED: Custom horizontal bar chart with party names on left
        function updateGraphs() {
            const startDate = document.getElementById('graphStartDate').value;
            const endDate = document.getElementById('graphEndDate').value;
            const partyType = document.getElementById('graphPartyType').value;
            const partyId = document.getElementById('graphParty').value;
            
            // Filter parties based on criteria
            let filteredParties = parties;
            
            if (partyType !== 'all') {
                filteredParties = filteredParties.filter(p => p.type === partyType);
            }
            
            if (partyId !== 'all') {
                filteredParties = filteredParties.filter(p => p.id === partyId);
            }
            
            // Filter transactions based on criteria
            let filteredTransactions = transactions;
            
            if (partyId !== 'all') {
                filteredTransactions = transactions.filter(t => t.party_id === partyId);
            } else if (partyType !== 'all') {
                const partyIds = filteredParties.map(p => p.id);
                filteredTransactions = transactions.filter(t => partyIds.includes(t.party_id));
            }
            
            filteredTransactions = filteredTransactions.filter(t => {
                const transDate = new Date(t.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                return transDate >= start && transDate <= end;
            });
            
            // Destroy existing charts
            if (charts.balanceChart) charts.balanceChart.destroy();
            if (charts.transactionChart) charts.transactionChart.destroy();
            
            // Don't use ApexCharts for party chart anymore - use custom HTML
            const partyChartContainer = document.getElementById('partyChart');
            if (partyChartContainer) {
                partyChartContainer.innerHTML = '';
            }
            
            // Create Balance Distribution Chart
            const debtors = filteredParties.filter(p => p.type === 'sundry_debtors');
            const creditors = filteredParties.filter(p => p.type === 'sundry_creditors');
            
            const totalDebtorsBalance = debtors.reduce((sum, p) => sum + (p.balance || 0), 0);
            const totalCreditorsBalance = creditors.reduce((sum, p) => sum + (p.balance || 0), 0);
            
            // Only show chart if there's data
            if (totalDebtorsBalance > 0 || totalCreditorsBalance > 0) {
                charts.balanceChart = new ApexCharts(document.querySelector("#balanceChart"), {
                    series: [Math.abs(totalDebtorsBalance), Math.abs(totalCreditorsBalance)],
                    chart: {
                        type: 'donut',
                        height: 300,
                        toolbar: {
                            show: false
                        }
                    },
                    labels: ['Sundry Debtors', 'Sundry Creditors'],
                    colors: ['#10b981', '#ef4444'],
                    legend: {
                        position: 'bottom'
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        label: 'Total Balance',
                                        formatter: function () {
                                            return formatCurrencyNoSymbol(totalDebtorsBalance - totalCreditorsBalance);
                                        }
                                    }
                                }
                            }
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: function(value) {
                                return formatCurrencyNoSymbol(value);
                            }
                        }
                    },
                    responsive: [{
                        breakpoint: 768,
                        options: {
                            chart: {
                                height: 250
                            },
                            legend: {
                                position: 'bottom',
                                horizontalAlign: 'center'
                            }
                        }
                    }]
                });
                charts.balanceChart.render();
            } else {
                document.querySelector("#balanceChart").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3>No balance data</h3>
                        <p>Adjust filters or add parties</p>
                    </div>
                `;
            }
            
            // Create Transaction Trends Chart
            const dailyTransactions = {};
            filteredTransactions.forEach(trans => {
                const date = trans.date;
                if (!dailyTransactions[date]) {
                    dailyTransactions[date] = { credit: 0, debit: 0 };
                }
                if (trans.type === 'credit') {
                    dailyTransactions[date].credit += trans.amount;
                } else {
                    dailyTransactions[date].debit += trans.amount;
                }
            });
            
            const dates = Object.keys(dailyTransactions).sort();
            const creditData = dates.map(date => dailyTransactions[date].credit);
            const debitData = dates.map(date => dailyTransactions[date].debit);
            
            if (dates.length > 0) {
                charts.transactionChart = new ApexCharts(document.querySelector("#transactionChart"), {
                    series: [{
                        name: 'Credit',
                        data: creditData
                    }, {
                        name: 'Debit',
                        data: debitData
                    }],
                    chart: {
                        type: 'area',
                        height: 300,
                        toolbar: {
                            show: false
                        }
                    },
                    colors: ['#10b981', '#ef4444'],
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        curve: 'smooth'
                    },
                    xaxis: {
                        type: 'datetime',
                        categories: dates,
                        labels: {
                            rotate: -45,
                            style: {
                                fontSize: window.innerWidth < 768 ? '9px' : '11px'
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            formatter: function(value) {
                                return formatCurrencyNoSymbol(value);
                            }
                        }
                    },
                    tooltip: {
                        x: {
                            format: 'dd MMM yyyy'
                        },
                        y: {
                            formatter: function(value) {
                                return formatCurrencyNoSymbol(value);
                            }
                        }
                    },
                    responsive: [{
                        breakpoint: 768,
                        options: {
                            chart: {
                                height: 250
                            },
                            xaxis: {
                                labels: {
                                    rotate: -45,
                                    style: {
                                        fontSize: '8px'
                                    }
                                }
                            }
                        }
                    }]
                });
                charts.transactionChart.render();
            } else {
                document.querySelector("#transactionChart").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>No transaction data</h3>
                        <p>Adjust filters or add transactions</p>
                    </div>
                `;
            }
            
            // Create Custom Party Balances Chart - NEW: Horizontal bar chart with names on left
            const sortedParties = [...filteredParties]
                .filter(p => Math.abs(p.balance || 0) > 0)
                .sort((a, b) => Math.abs(b.balance || 0) - Math.abs(a.balance || 0))
                .slice(0, window.innerWidth < 768 ? 8 : 12); // Show fewer on mobile
            
            if (sortedParties.length > 0) {
                // Find maximum balance for scaling
                const maxBalance = Math.max(...sortedParties.map(p => Math.abs(p.balance || 0)));
                
                // Create custom chart HTML
                const chartHTML = `
                    <div class="horizontal-bar-chart">
                        <div class="chart-labels-container">
                            <span>Party Name</span>
                            <span>Balance</span>
                        </div>
                        <div class="chart-bars-container">
                            ${sortedParties.map(party => {
                                const balance = party.balance || 0;
                                const absBalance = Math.abs(balance);
                                const percentage = maxBalance > 0 ? (absBalance / maxBalance * 100) : 0;
                                const isDebtor = party.type === 'sundry_debtors';
                                const colorClass = isDebtor ? 'debtor' : 'creditor';
                                const formattedBalance = formatCurrencyNoSymbol(absBalance);
                                const prefix = isDebtor ? (balance >= 0 ? '+' : '-') : (balance >= 0 ? '-' : '+');
                                const balanceText = `${prefix}₹${formattedBalance}`;
                                const typeLabel = isDebtor ? 'Debtor' : 'Creditor';
                                
                                // Truncate long names
                                let displayName = party.name;
                                const maxNameLength = window.innerWidth < 768 ? 20 : 30;
                                if (displayName.length > maxNameLength) {
                                    displayName = displayName.substring(0, maxNameLength) + '...';
                                }
                                
                                return `
                                    <div class="chart-bar-item">
                                        <div class="chart-party-name" title="${party.name}">
                                            ${displayName}
                                        </div>
                                        <div class="chart-bar-track">
                                            <div class="chart-bar-fill ${colorClass}" style="width: ${percentage}%">
                                                <div class="chart-bar-value">${prefix}₹${formattedBalance}</div>
                                            </div>
                                        </div>
                                        <div class="chart-party-balance ${colorClass}">
                                            ${balanceText}
                                        </div>
                                        <div class="chart-party-type">
                                            <span class="chart-party-type-badge ${colorClass}">
                                                ${typeLabel}
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('partyChart').innerHTML = chartHTML;
            } else {
                document.querySelector("#partyChart").innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-area"></i>
                        </div>
                        <h3>No party data</h3>
                        <p>Adjust filters or add parties</p>
                    </div>
                `;
            }
        }

        // Show print/export view
        async function showPrint() {
            showLoading();
            
            try {
                // Update mobile nav
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                
                const html = `
                    <div class="print-container">
                        <h1 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--dark);">
                            <i class="fas fa-print"></i> Generate Reports
                        </h1>
                        
                        <div class="filters-container">
                            <div class="filter-group">
                                <label class="form-label">Report Type</label>
                                <select class="form-control" id="reportType" onchange="changeReportType()">
                                    <option value="party-summary">Party Summary Report</option>
                                    <option value="transaction-details">Transaction Details Report</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="printStartDate">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="printEndDate">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Party</label>
                                <select class="form-control" id="printParty">
                                    <option value="all">All Parties</option>
                                    ${parties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-primary" onclick="generatePrintPreview()" tabindex="0" style="margin-top: 8px;">
                                    <i class="fas fa-eye"></i> Generate Preview
                                </button>
                            </div>
                        </div>
                        
                        <div id="printPreview"></div>
                    </div>
                `;
                
                mainContent.innerHTML = html;
                
                // Set default dates
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                document.getElementById('printStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
                document.getElementById('printEndDate').value = today.toISOString().split('T')[0];
                
            } catch (error) {
                showToast('Failed to load print view: ' + error.message, 'error');
                console.error('Print view error:', error);
            }
            
            hideLoading();
        }

        // Change report type
        function changeReportType() {
            currentReportType = document.getElementById('reportType').value;
        }

        // Generate print preview - UPDATED: Removed PDF button
        async function generatePrintPreview() {
            showLoading();
            
            try {
                const startDate = document.getElementById('printStartDate').value;
                const endDate = document.getElementById('printEndDate').value;
                const partyId = document.getElementById('printParty').value;
                const reportType = document.getElementById('reportType').value;
                
                // Filter data based on criteria
                let filteredTransactions = transactions;
                let filteredParties = parties;
                
                if (partyId !== 'all') {
                    filteredParties = parties.filter(p => p.id === partyId);
                    filteredTransactions = transactions.filter(t => t.party_id === partyId);
                }
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const transDate = new Date(t.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return transDate >= start && transDate <= end;
                });
                
                // Sort transactions by date
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Calculate totals
                const totalCredit = filteredTransactions
                    .filter(t => t.type === 'credit')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalDebit = filteredTransactions
                    .filter(t => t.type === 'debit')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const netTotal = totalCredit - totalDebit;
                
                let previewHTML = '';
                
                if (reportType === 'party-summary') {
                    previewHTML = generatePartySummaryReport(filteredParties, filteredTransactions, startDate, endDate, partyId, totalCredit, totalDebit, netTotal);
                } else {
                    previewHTML = generateTransactionDetailsReport(filteredParties, filteredTransactions, startDate, endDate, partyId, totalCredit, totalDebit, netTotal);
                }
                
                document.getElementById('printPreview').innerHTML = previewHTML;
                
            } catch (error) {
                showToast('Failed to generate preview: ' + error.message, 'error');
                console.error('Print preview error:', error);
            }
            
            hideLoading();
        }

        // Generate party summary report - UPDATED: Removed PDF button
        function generatePartySummaryReport(filteredParties, filteredTransactions, startDate, endDate, partyId, totalCredit, totalDebit, netTotal) {
            let totalOpeningBalance = 0;
            let totalCreditAmount = 0;
            let totalDebitAmount = 0;
            let totalClosingBalance = 0;
            
            const partyRows = filteredParties.map((party, index) => {
                const partyTransactions = filteredTransactions.filter(t => t.party_id === party.id);
                const partyCredit = partyTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const partyDebit = partyTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const openingBalance = party.balance - (party.type === 'sundry_debtors' ? (partyCredit - partyDebit) : (partyDebit - partyCredit));
                const closingBalance = party.balance;
                
                totalOpeningBalance += openingBalance;
                totalCreditAmount += partyCredit;
                totalDebitAmount += partyDebit;
                totalClosingBalance += closingBalance;
                
                // FIXED: Determine color based on party type and balance
                let balanceClass = '';
                if (party.type === 'sundry_creditors') {
                    // Always show creditors in red (even if balance is positive)
                    balanceClass = 'balance-creditor';
                } else if (party.type === 'sundry_debtors') {
                    // Debtors show in green if positive, red if negative
                    balanceClass = closingBalance >= 0 ? 'balance-debtor' : 'balance-creditor';
                }
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${party.name}</td>
                        <td>
                            <span class="party-type-badge ${party.type === 'sundry_debtors' ? 'party-type-debtor' : 'party-type-creditor'}">
                                ${party.type === 'sundry_debtors' ? 'Debtor' : 'Creditor'}
                            </span>
                        </td>
                        <td class="currency-column">${formatCurrencyNoSymbol(openingBalance)}</td>
                        <td class="currency-column">${formatCurrencyNoSymbol(partyCredit)}</td>
                        <td class="currency-column">${formatCurrencyNoSymbol(partyDebit)}</td>
                        <td class="currency-column ${balanceClass}">
                            ${formatCurrencyNoSymbol(closingBalance)}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // FIXED: Determine total closing balance color
            let totalClosingBalanceClass = '';
            if (filteredParties.some(p => p.type === 'sundry_creditors')) {
                // If there are creditors in the list, show in red
                totalClosingBalanceClass = 'balance-creditor';
            } else {
                // Only debtors - show green if positive, red if negative
                totalClosingBalanceClass = totalClosingBalance >= 0 ? 'balance-debtor' : 'balance-creditor';
            }
            
            return `
                <div class="print-preview" id="printContent">
                    <div class="print-header">
                        <div class="print-title">Party Summary Report</div>
                        <div class="print-subtitle">
                            ${formatDate(startDate)} to ${formatDate(endDate)}
                            ${partyId !== 'all' ? ` • Party: ${filteredParties[0]?.name || 'N/A'}` : ''}
                        </div>
                        <div class="print-subtitle" style="margin-top: 8px;">
                            Generated on ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    
                    ${filteredParties.length > 0 ? `
                    <div class="print-section">
                        <div class="print-section-title">
                            <i class="fas fa-users"></i> Party Summary
                        </div>
                        <div class="table-container">
                            <table class="print-table">
                                <thead>
                                    <tr>
                                        <th>S.No.</th>
                                        <th>Party Name</th>
                                        <th>Type</th>
                                        <th class="currency-column">Opening Balance</th>
                                        <th class="currency-column">Credit Amount</th>
                                        <th class="currency-column">Debit Amount</th>
                                        <th class="currency-column">Closing Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${partyRows}
                                    <tr class="print-total-row">
                                        <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                        <td class="currency-column" style="font-weight: bold;">${formatCurrencyNoSymbol(totalOpeningBalance)}</td>
                                        <td class="currency-column" style="font-weight: bold;">${formatCurrencyNoSymbol(totalCreditAmount)}</td>
                                        <td class="currency-column" style="font-weight: bold;">${formatCurrencyNoSymbol(totalDebitAmount)}</td>
                                        <td class="currency-column" style="font-weight: bold; ${totalClosingBalanceClass}">
                                            ${formatCurrencyNoSymbol(totalClosingBalance)}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : '<div class="empty-state"><i class="fas fa-users"></i><h3>No parties found</h3></div>'}
                    
                    <div class="print-summary">
                        <div class="print-summary-item">
                            <div class="print-summary-label">Total Parties</div>
                            <div class="print-summary-value">${filteredParties.length}</div>
                        </div>
                        <div class="print-summary-item">
                            <div class="print-summary-label">Total Credit</div>
                            <div class="print-summary-value balance-debtor">${formatCurrencyNoSymbol(totalCredit)}</div>
                        </div>
                        <div class="print-summary-item">
                            <div class="print-summary-label">Total Debit</div>
                            <div class="print-summary-value balance-creditor">${formatCurrencyNoSymbol(totalDebit)}</div>
                        </div>
                        <div class="print-summary-item">
                            <div class="print-summary-label">Net Position</div>
                            <div class="print-summary-value ${netTotal >= 0 ? 'balance-debtor' : 'balance-creditor'}">
                                ${formatCurrencyNoSymbol(Math.abs(netTotal))}
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-actions">
                        <button class="btn btn-primary" onclick="printReport()" tabindex="0">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                        <button class="btn btn-outline" onclick="exportToExcel()" tabindex="0">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            `;
        }

        // Generate transaction details report - UPDATED: Removed PDF button
        function generateTransactionDetailsReport(filteredParties, filteredTransactions, startDate, endDate, partyId, totalCredit, totalDebit, netTotal) {
            return `
                <div class="print-preview" id="printContent">
                    <div class="print-header">
                        <div class="print-title">Transaction Details Report</div>
                        <div class="print-subtitle">
                            ${formatDate(startDate)} to ${formatDate(endDate)}
                            ${partyId !== 'all' ? ` • Party: ${filteredParties[0]?.name || 'N/A'}` : ''}
                        </div>
                        <div class="print-subtitle" style="margin-top: 8px;">
                            Generated on ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    
                    ${filteredTransactions.length > 0 ? `
                    <div class="print-section">
                        <div class="print-section-title">
                            <i class="fas fa-exchange-alt"></i> Transaction Details
                        </div>
                        <div class="table-container">
                            <table class="print-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Party Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th class="currency-column">Amount</th>
                                        <th class="currency-column">Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredTransactions.map(trans => {
                                        const party = parties.find(p => p.id === trans.party_id);
                                        // FIXED: Determine balance color based on party type
                                        let balanceColor = '';
                                        if (party?.type === 'sundry_creditors') {
                                            // Always show creditors in red
                                            balanceColor = 'balance-creditor';
                                        } else if (party?.type === 'sundry_debtors') {
                                            // Debtors show in green if positive, red if negative
                                            balanceColor = trans.new_balance >= 0 ? 'balance-debtor' : 'balance-creditor';
                                        }
                                        return `
                                            <tr>
                                                <td>${formatDate(trans.date)}</td>
                                                <td>${party?.name || 'N/A'}</td>
                                                <td>
                                                    <span class="transaction-type ${trans.type === 'credit' ? 'credit' : 'debit'}">
                                                        ${trans.type === 'credit' ? 'Credit' : 'Debit'}
                                                    </span>
                                                </td>
                                                <td>${trans.description || '-'}</td>
                                                <td class="currency-column ${trans.type === 'credit' ? 'balance-debtor' : 'balance-creditor'}">
                                                    ${formatCurrencyNoSymbol(trans.amount)}
                                                </td>
                                                <td class="currency-column ${balanceColor}">
                                                    ${formatCurrencyNoSymbol(trans.new_balance || 0)}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr class="print-total-row">
                                        <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                        <td class="currency-column" style="font-weight: bold;">
                                            <span class="${totalCredit > totalDebit ? 'balance-debtor' : 'balance-creditor'}">
                                                ${formatCurrencyNoSymbol(totalCredit + totalDebit)}
                                            </span>
                                        </td>
                                        <td class="currency-column" style="font-weight: bold; ${netTotal >= 0 ? 'color: var(--success);' : 'color: var(--danger);'}">
                                            ${formatCurrencyNoSymbol(netTotal)}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : '<div class="empty-state"><i class="fas fa-exchange-alt"></i><h3>No transactions found</h3></div>'}
                    
                    <div class="print-summary">
                        <div class="print-summary-item">
                            <div class="print-summary-label">Total Transactions</div>
                            <div class="print-summary-value">${filteredTransactions.length}</div>
                        </div>
                        <div class="print-summary-item">
                            <div class="print-summary-label">Total Credit</div>
                            <div class="print-summary-value balance-debtor">${formatCurrencyNoSymbol(totalCredit)}</div>
                        </div>
                        <div class="print-summary-item">
                            <div class="print-summary-label">Total Debit</div>
                            <div class="print-summary-value balance-creditor">${formatCurrencyNoSymbol(totalDebit)}</div>
                        </div>
                        <div class="print-summary-item">
                            <div class="print-summary-label">Net Total</div>
                            <div class="print-summary-value ${netTotal >= 0 ? 'balance-debtor' : 'balance-creditor'}">
                                ${formatCurrencyNoSymbol(Math.abs(netTotal))}
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-actions">
                        <button class="btn btn-primary" onclick="printReport()" tabindex="0">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                        <button class="btn btn-outline" onclick="exportToExcel()" tabindex="0">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            `;
        }

        // Print report
        function printReport() {
            const printContent = document.getElementById('printContent');
            const originalContent = document.body.innerHTML;
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            
            // Get report title
            const reportTitle = document.querySelector('.print-title').textContent;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            body {
                                font-family: Arial, sans-serif;
                                margin: 0;
                                padding: 0;
                                font-size: 12px;
                            }
                            .print-header {
                                text-align: center;
                                margin-bottom: 20px;
                                padding-bottom: 10px;
                                border-bottom: 2px solid #ddd;
                            }
                            .print-title {
                                font-size: 20px;
                                font-weight: bold;
                                margin-bottom: 5px;
                            }
                            .print-subtitle {
                                color: #666;
                                font-size: 12px;
                                margin-bottom: 5px;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 10px;
                                font-size: 10px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 6px;
                                text-align: left;
                            }
                            th {
                                background-color: #f4f4f4;
                                font-weight: bold;
                            }
                            .currency-column {
                                text-align: right;
                                font-family: monospace;
                            }
                            .print-total-row {
                                background-color: #f0f0f0;
                                font-weight: bold;
                                border-top: 2px solid #666;
                            }
                            .print-summary {
                                display: flex;
                                flex-wrap: nowrap;
                                gap: 10px;
                                margin-top: 20px;
                                page-break-inside: avoid;
                            }
                            .print-summary-item {
                                background-color: #f9f9f9;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                min-width: 150px;
                            }
                            .print-actions {
                                display: none !important;
                            }
                            /* Remove ₹ symbol and colors from print */
                            .balance-debtor,
                            .balance-creditor,
                            .balance-zero,
                            .print-summary-value,
                            .currency-column {
                                color: black !important;
                            }
                            .currency-column::before,
                            .print-summary-value::before {
                                content: "" !important;
                            }
                        }
                        @media screen {
                            body { 
                                padding: 20px; 
                                font-family: Arial, sans-serif;
                            }
                            .print-actions { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Export to Excel
        function exportToExcel() {
            try {
                showToast('Generating Excel file...', 'info');
                
                const startDate = document.getElementById('printStartDate').value;
                const endDate = document.getElementById('printEndDate').value;
                const partyId = document.getElementById('printParty').value;
                const reportType = document.getElementById('reportType').value;
                
                // Filter data
                let filteredTransactions = transactions;
                let filteredParties = parties;
                
                if (partyId !== 'all') {
                    filteredParties = parties.filter(p => p.id === partyId);
                    filteredTransactions = transactions.filter(t => t.party_id === partyId);
                }
                
                filteredTransactions = filteredTransactions.filter(t => {
                    const transDate = new Date(t.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return transDate >= start && transDate <= end;
                });
                
                // Calculate totals
                const totalCredit = filteredTransactions
                    .filter(t => t.type === 'credit')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalDebit = filteredTransactions
                    .filter(t => t.type === 'debit')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const netTotal = totalCredit - totalDebit;
                
                let workbook = XLSX.utils.book_new();
                
                if (reportType === 'party-summary') {
                    // Create Party Summary worksheet
                    const partyData = filteredParties.map((party, index) => {
                        const partyTransactions = filteredTransactions.filter(t => t.party_id === party.id);
                        const partyCredit = partyTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                        const partyDebit = partyTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                        const openingBalance = party.balance - (party.type === 'sundry_debtors' ? (partyCredit - partyDebit) : (partyDebit - partyCredit));
                        
                        return {
                            'S.No.': index + 1,
                            'Party Name': party.name,
                            'Type': party.type === 'sundry_debtors' ? 'Sundry Debtor' : 'Sundry Creditor',
                            'Opening Balance': openingBalance,
                            'Credit Amount': partyCredit,
                            'Debit Amount': partyDebit,
                            'Closing Balance': party.balance || 0
                        };
                    });
                    
                    // Add totals row
                    partyData.push({
                        'S.No.': 'TOTAL',
                        'Party Name': '',
                        'Type': '',
                        'Opening Balance': filteredParties.reduce((sum, p) => {
                            const partyTransactions = filteredTransactions.filter(t => t.party_id === p.id);
                            const partyCredit = partyTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                            const partyDebit = partyTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                            const openingBalance = p.balance - (p.type === 'sundry_debtors' ? (partyCredit - partyDebit) : (partyDebit - partyCredit));
                            return sum + openingBalance;
                        }, 0),
                        'Credit Amount': totalCredit,
                        'Debit Amount': totalDebit,
                        'Closing Balance': filteredParties.reduce((sum, p) => sum + (p.balance || 0), 0)
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(partyData);
                    
                    // Format currency columns
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let C = 3; C <= 6; ++C) {
                        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                            const cell_address = {c: C, r: R};
                            const cell_ref = XLSX.utils.encode_cell(cell_address);
                            if (ws[cell_ref]) {
                                ws[cell_ref].z = '#,##0.00';
                            }
                        }
                    }
                    
                    // Set column widths
                    const wscols = [
                        {wch: 8},  // S.No.
                        {wch: 30}, // Party Name
                        {wch: 15}, // Type
                        {wch: 15}, // Opening Balance
                        {wch: 15}, // Credit Amount
                        {wch: 15}, // Debit Amount
                        {wch: 15}  // Closing Balance
                    ];
                    ws['!cols'] = wscols;
                    
                    XLSX.utils.book_append_sheet(workbook, ws, 'Party Summary');
                    
                } else {
                    // Create Transaction Details worksheet
                    const transactionData = filteredTransactions.map((trans, index) => {
                        const party = parties.find(p => p.id === trans.party_id);
                        
                        return {
                            'S.No.': index + 1,
                            'Date': formatDate(trans.date),
                            'Party Name': party?.name || 'N/A',
                            'Type': trans.type === 'credit' ? 'Credit' : 'Debit',
                            'Description': trans.description || '',
                            'Payment Mode': trans.payment_mode || '',
                            'Amount': trans.amount,
                            'Balance After': trans.new_balance || 0
                        };
                    });
                    
                    // Add totals row
                    transactionData.push({
                        'S.No.': 'TOTAL',
                        'Date': '',
                        'Party Name': '',
                        'Type': '',
                        'Description': '',
                        'Payment Mode': '',
                        'Amount': totalCredit + totalDebit,
                        'Balance After': netTotal
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(transactionData);
                    
                    // Format currency columns
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let C = 6; C <= 7; ++C) {
                        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                            const cell_address = {c: C, r: R};
                            const cell_ref = XLSX.utils.encode_cell(cell_address);
                            if (ws[cell_ref]) {
                                ws[cell_ref].z = '#,##0.00';
                            }
                        }
                    }
                    
                    // Set column widths
                    const wscols = [
                        {wch: 8},   // S.No.
                        {wch: 15},  // Date
                        {wch: 30},  // Party Name
                        {wch: 10},  // Type
                        {wch: 40},  // Description
                        {wch: 15},  // Payment Mode
                        {wch: 15},  // Amount
                        {wch: 15}   // Balance After
                    ];
                    ws['!cols'] = wscols;
                    
                    XLSX.utils.book_append_sheet(workbook, ws, 'Transaction Details');
                }
                
                // Create Summary worksheet
                const summaryData = [
                    ['Report Summary'],
                    [''],
                    ['Report Type:', reportType === 'party-summary' ? 'Party Summary Report' : 'Transaction Details Report'],
                    ['Date Range:', `${formatDate(startDate)} to ${formatDate(endDate)}`],
                    partyId !== 'all' ? ['Party:', filteredParties[0]?.name || 'N/A'] : ['Party:', 'All Parties'],
                    ['Generated On:', new Date().toLocaleDateString('en-IN') + ' ' + new Date().toLocaleTimeString('en-IN')],
                    [''],
                    reportType === 'party-summary' ? ['Total Parties:', filteredParties.length] : ['Total Transactions:', filteredTransactions.length],
                    ['Total Credit:', totalCredit],
                    ['Total Debit:', totalDebit],
                    ['Net Position:', netTotal]
                ];
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Format currency cells in summary
                wsSummary['B9'] = { v: totalCredit, t: 'n', z: '#,##0.00' };
                wsSummary['B10'] = { v: totalDebit, t: 'n', z: '#,##0.00' };
                wsSummary['B11'] = { v: netTotal, t: 'n', z: '#,##0.00' };
                
                XLSX.utils.book_append_sheet(workbook, wsSummary, 'Summary');
                
                // Generate filename and save
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `BalanceTrack_${reportType}_${timestamp}.xlsx`;
                XLSX.writeFile(workbook, filename);
                
                showToast('Excel file downloaded successfully!', 'success');
                
            } catch (error) {
                showToast('Failed to generate Excel file: ' + error.message, 'error');
                console.error('Excel export error:', error);
            }
        }

        // Show debtors only
        function showDebtors() {
            filterPartiesByType('sundry_debtors');
            document.querySelectorAll('.party-type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.onclick && tab.onclick.toString().includes("'sundry_debtors'")) {
                    tab.classList.add('active');
                }
            });
        }

        // Show creditors only
        function showCreditors() {
            filterPartiesByType('sundry_creditors');
            document.querySelectorAll('.party-type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.onclick && tab.onclick.toString().includes("'sundry_creditors'")) {
                    tab.classList.add('active');
                }
            });
        }

        // Show all parties
        function showAllParties() {
            filterPartiesByType('all');
            document.querySelectorAll('.party-type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.onclick && tab.onclick.toString().includes("'all'")) {
                    tab.classList.add('active');
                }
            });
        }

        // Render parties table - FIXED: Always show creditors in red
        function renderPartiesTable(filterType = 'all') {
            let filteredParties = parties;
            
            if (filterType !== 'all') {
                filteredParties = parties.filter(p => p.type === filterType);
            }
            
            if (filteredParties.length === 0) {
                return `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3>No parties found</h3>
                            <p>Add your first party to get started</p>
                        </td>
                    </tr>
                `;
            }
            
            return filteredParties.map((party, index) => {
                const balance = party.balance || 0;
                const type = party.type === 'sundry_debtors' ? 'debtor' : 'creditor';
                
                // FIXED: Always show creditors in red, debtors show green if positive, red if negative
                let balanceClass = '';
                if (type === 'creditor') {
                    balanceClass = 'balance-creditor'; // Always red for creditors
                } else {
                    balanceClass = balance >= 0 ? 'balance-debtor' : 'balance-creditor';
                }
                
                const zeroBalance = balance === 0 ? 'balance-zero' : '';
                
                return `
                    <tr tabindex="0" onclick="viewPartyDetails('${party.id}')" 
                         onkeydown="if(event.key==='Enter') viewPartyDetails('${party.id}')"
                         data-index="${index}">
                        <td><strong>${party.name}</strong></td>
                        <td class="currency-cell ${balanceClass} ${zeroBalance}">
                            ₹${formatCurrency(balance)}
                        </td>
                        <td>
                            <span class="party-type-badge party-type-${type}">
                                ${type === 'debtor' ? 'Sundry Debtor' : 'Sundry Creditor'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${party.status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${party.status || 'active'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <div class="action-icon view" onclick="event.stopPropagation(); viewPartyDetails('${party.id}')" title="View" tabindex="0">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="action-icon edit" onclick="event.stopPropagation(); editParty('${party.id}')" title="Edit" tabindex="0">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-icon delete" onclick="event.stopPropagation(); confirmDeleteParty('${party.id}', '${party.name.replace(/'/g, "\\'")}')" title="Delete" tabindex="0" style="border-color: var(--danger); color: var(--danger);">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Confirm party deletion
        function confirmDeleteParty(partyId, partyName) {
            document.getElementById('confirmationTitle').textContent = 'Delete Party';
            document.getElementById('confirmationText').textContent = `Are you sure you want to delete "${partyName}"? This will also delete all associated transactions. This action cannot be undone.`;
            document.getElementById('confirmationModal').classList.add('active');
            
            pendingAction = () => deleteParty(partyId, partyName);
        }

        // Confirm transaction deletion
        function confirmDeleteTransaction(transactionId, amount) {
            document.getElementById('confirmationTitle').textContent = 'Delete Transaction';
            document.getElementById('confirmationText').textContent = `Are you sure you want to delete this transaction of ₹${amount.toFixed(2)}? This action cannot be undone.`;
            document.getElementById('confirmationModal').classList.add('active');
            
            pendingAction = () => deleteTransaction(transactionId);
        }

        // Handle confirmation
        function handleConfirmation() {
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
            closeModal('confirmation');
        }

        // Filter parties by type
        function filterPartiesByType(type) {
            const tabs = document.querySelectorAll('.party-type-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Find and activate the correct tab
            tabs.forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(`'${type}'`)) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById('partiesTableBody').innerHTML = renderPartiesTable(type);
            selectedRowIndex = -1;
        }

        // Filter parties by search
        function filterParties() {
            const searchTerm = document.getElementById('partySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#partiesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            selectedRowIndex = -1;
        }

        // View party details - FIXED: Always show creditors in red
        async function viewPartyDetails(partyId) {
            showLoading();
            
            try {
                // Find the party
                currentParty = parties.find(p => p.id === partyId);
                if (!currentParty) {
                    showToast('Party not found', 'error');
                    hideLoading();
                    return;
                }
                
                // Load party transactions
                await loadPartyTransactions(partyId);
                
                // Calculate additional stats
                const totalTransactions = currentPartyTransactions.length;
                const creditTransactions = currentPartyTransactions.filter(t => t.type === 'credit').length;
                const debitTransactions = currentPartyTransactions.filter(t => t.type === 'debit').length;
                
                // Calculate opening balance
                let openingBalance = 0;
                if (currentPartyTransactions.length > 0) {
                    openingBalance = currentPartyTransactions[currentPartyTransactions.length - 1].previous_balance || 0;
                }
                
                // FIXED: Determine balance color - always red for creditors
                let balanceColor = '';
                let zeroBalance = '';
                
                if (currentParty.type === 'sundry_creditors') {
                    // Always show creditors in red
                    balanceColor = 'balance-creditor';
                    zeroBalance = currentParty.balance === 0 ? 'balance-zero' : '';
                } else {
                    // Debtors show green if positive, red if negative
                    balanceColor = currentParty.balance >= 0 ? 'balance-debtor' : 'balance-creditor';
                    zeroBalance = currentParty.balance === 0 ? 'balance-zero' : '';
                }
                
                // Build party details page
                const html = `
                    <div class="party-details-page">
                        <div class="party-header">
                            <div class="party-header-back" onclick="showDashboard()" tabindex="0">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </div>
                            
                            <div class="party-header-main">
                                <div class="party-header-info">
                                    <h1>${currentParty.name}</h1>
                                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 8px;">
                                        <span class="party-type-badge ${currentParty.type === 'sundry_debtors' ? 'party-type-debtor' : 'party-type-creditor'}" style="font-size: 0.875rem;">
                                            ${currentParty.type === 'sundry_debtors' ? 'Sundry Debtor' : 'Sundry Creditor'}
                                        </span>
                                        <span class="status-badge ${currentParty.status === 'active' ? 'status-active' : 'status-inactive'}">
                                            ${currentParty.status || 'active'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="party-header-actions">
                                    <button class="btn btn-primary" onclick="openTransactionModal('${currentParty.id}')" tabindex="0">
                                        <i class="fas fa-plus"></i> Add Transaction
                                    </button>
                                    <button class="btn btn-outline" onclick="editParty('${currentParty.id}')" tabindex="0" style="background: rgba(255, 255, 255, 0.1); color: white; border-color: white;">
                                        <i class="fas fa-edit"></i> Edit Party
                                    </button>
                                    <button class="btn btn-danger" onclick="confirmDeleteParty('${currentParty.id}', '${currentParty.name.replace(/'/g, "\\'")}')" tabindex="0" style="background: rgba(255, 59, 48, 0.2); color: white; border-color: rgba(255, 255, 255, 0.3);">
                                        <i class="fas fa-trash"></i> Delete Party
                                    </button>
                                </div>
                            </div>
                            
                            <div class="party-header-stats">
                                <div class="party-stat">
                                    <div class="party-stat-label">Current Balance</div>
                                    <div class="party-stat-value currency-display ${balanceColor} ${zeroBalance}">
                                        ${formatCurrency(currentParty.balance || 0)}
                                    </div>
                                </div>
                                <div class="party-stat">
                                    <div class="party-stat-label">Opening Balance</div>
                                    <div class="party-stat-value currency-display">
                                        ${formatCurrency(openingBalance)}
                                    </div>
                                </div>
                                <div class="party-stat">
                                    <div class="party-stat-label">Total Transactions</div>
                                    <div class="party-stat-value">${totalTransactions}</div>
                                </div>
                                <div class="party-stat">
                                    <div class="party-stat-label">Last Activity</div>
                                    <div class="party-stat-value">
                                        ${currentParty.last_activity ? formatDate(currentParty.last_activity) : 'None'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="party-content">
                            <div class="transactions-section">
                                <div class="section-header">
                                    <div class="section-title">Transaction History</div>
                                    <div>
                                        <span style="font-size: 0.875rem; color: var(--gray-600);">
                                            Showing ${currentPartyTransactions.length} transactions
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="transactions-list" id="transactionsList">
                                    ${renderPartyTransactions()}
                                </div>
                            </div>
                            
                            <div class="party-info-sidebar">
                                <div class="info-card">
                                    <div class="info-card-title">
                                        <i class="fas fa-info-circle"></i> Party Information
                                    </div>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <span class="info-label">Party Type</span>
                                            <span class="info-value">
                                                <span class="party-type-badge ${currentParty.type === 'sundry_debtors' ? 'party-type-debtor' : 'party-type-creditor'}">
                                                    ${currentParty.type === 'sundry_debtors' ? 'Sundry Debtor' : 'Sundry Creditor'}
                                                </span>
                                            </span>
                                        </div>
                                        ${currentParty.gstin ? `
                                        <div class="info-item">
                                            <span class="info-label">GSTIN</span>
                                            <span class="info-value">${currentParty.gstin}</span>
                                        </div>
                                        ` : ''}
                                        <div class="info-item">
                                            <span class="info-label">Email</span>
                                            <span class="info-value">${currentParty.email || 'Not provided'}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Phone</span>
                                            <span class="info-value">${currentParty.phone || 'Not provided'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="info-card">
                                    <div class="info-card-title">
                                        <i class="fas fa-chart-bar"></i> Transaction Summary
                                    </div>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <span class="info-label">Total Credits</span>
                                            <span class="info-value">${creditTransactions}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Total Debits</span>
                                            <span class="info-value">${debitTransactions}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Opening Balance</span>
                                            <span class="info-value currency-display">${formatCurrency(openingBalance)}</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Current Balance</span>
                                            <span class="info-value currency-display ${balanceColor} ${zeroBalance}">
                                                ${formatCurrency(currentParty.balance || 0)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${currentParty.address || currentParty.notes ? `
                                <div class="info-card">
                                    <div class="info-card-title">
                                        <i class="fas fa-sticky-note"></i> Additional Information
                                    </div>
                                    <div class="info-grid">
                                        ${currentParty.address ? `
                                        <div class="info-item" style="flex-direction: column; align-items: flex-start;">
                                            <span class="info-label">Address</span>
                                            <span class="info-value" style="text-align: left; margin-top: 0.25rem;">${currentParty.address}</span>
                                        </div>
                                        ` : ''}
                                        ${currentParty.notes ? `
                                        <div class="info-item" style="flex-direction: column; align-items: flex-start;">
                                            <span class="info-label">Notes</span>
                                            <span class="info-value" style="text-align: left; margin-top: 0.25rem;">${currentParty.notes}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                mainContent.innerHTML = html;
                selectedTransactionIndex = -1;
                
            } catch (error) {
                showToast('Failed to load party details: ' + error.message, 'error');
                console.error('Error loading party details:', error);
            }
            
            hideLoading();
        }

        // Render party transactions - FIXED: Always show creditors in red
        function renderPartyTransactions() {
            if (currentPartyTransactions.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <h3>No transactions yet</h3>
                        <p>Start by adding a transaction</p>
                        <button class="btn btn-primary" onclick="openTransactionModal('${currentParty.id}')" style="margin-top: 1rem;" tabindex="0">
                            <i class="fas fa-plus"></i> Add First Transaction
                        </button>
                    </div>
                `;
            }
            
            return currentPartyTransactions.map((transaction, index) => {
                const isCredit = transaction.type === 'credit';
                const amount = transaction.amount;
                const balanceAfter = transaction.new_balance;
                
                // FIXED: Determine balance color based on party type
                let balanceColor = '';
                if (currentParty.type === 'sundry_creditors') {
                    // Always show creditors in red
                    balanceColor = 'balance-creditor';
                } else {
                    // Debtors show green if positive, red if negative
                    balanceColor = balanceAfter >= 0 ? 'balance-debtor' : 'balance-creditor';
                }
                
                return `
                    <div class="transaction-item ${isCredit ? 'credit' : 'debit'}" 
                         onclick="editTransaction('${transaction.id}')"
                         onkeydown="if(event.key==='Enter') editTransaction('${transaction.id}')"
                         tabindex="0"
                         data-index="${index}">
                        <div class="transaction-header">
                            <div class="transaction-date">${formatDateTime(transaction.date)}</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="transaction-type ${isCredit ? 'credit' : 'debit'}">
                                    ${isCredit ? 'Credit' : 'Debit'}
                                </span>
                                <div class="action-icon delete" onclick="event.stopPropagation(); confirmDeleteTransaction('${transaction.id}', ${amount})" title="Delete" tabindex="0" style="width: 32px; height: 32px; font-size: 14px; border-color: var(--danger); color: var(--danger);">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="transaction-description">
                            ${transaction.description || (isCredit ? 'Credit transaction' : 'Debit transaction')}
                            ${transaction.payment_mode ? `<div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">Mode: ${transaction.payment_mode.replace('_', ' ').toUpperCase()}</div>` : ''}
                        </div>
                        
                        <div class="transaction-footer">
                            <div class="transaction-amount ${isCredit ? 'balance-debtor' : 'balance-creditor'}">
                                ${isCredit ? '+' : '-'}₹${formatCurrency(amount)}
                            </div>
                            <div class="transaction-balance ${balanceColor}">
                                Balance: ₹${formatCurrency(balanceAfter)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open party modal
        function openPartyModal(partyId = null) {
            const form = document.getElementById('partyForm');
            const title = document.getElementById('partyModalTitle');
            
            form.reset();
            
            if (partyId) {
                // Edit mode
                const party = parties.find(p => p.id === partyId);
                if (party) {
                    document.getElementById('partyName').value = party.name;
                    document.getElementById('partyType').value = party.type;
                    document.getElementById('initialBalance').value = party.balance || 0;
                    document.getElementById('partyGSTIN').value = party.gstin || '';
                    document.getElementById('partyAddress').value = party.address || '';
                    document.getElementById('partyEmail').value = party.email || '';
                    document.getElementById('partyPhone').value = party.phone || '';
                    document.getElementById('partyNotes').value = party.notes || '';
                    form.dataset.editing = partyId;
                    title.textContent = 'Edit Party';
                }
            } else {
                // Add mode
                delete form.dataset.editing;
                title.textContent = 'Add New Party';
                document.getElementById('initialBalance').value = '0';
            }
            
            document.getElementById('partyModal').classList.add('active');
            setTimeout(() => document.getElementById('partyName').focus(), 100);
        }

        // Open transaction modal
        function openTransactionModal(partyId = null, transactionId = null) {
            const form = document.getElementById('transactionForm');
            const title = document.getElementById('transactionModalTitle');
            
            form.reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('transactionPartySearch').value = '';
            document.getElementById('transactionParty').value = '';
            
            if (transactionId) {
                // Edit mode
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction) {
                    const party = parties.find(p => p.id === transaction.party_id);
                    document.getElementById('transactionId').value = transaction.id;
                    document.getElementById('transactionPartySearch').value = party ? party.name : '';
                    document.getElementById('transactionParty').value = transaction.party_id;
                    document.getElementById('transactionDate').value = transaction.date;
                    document.getElementById('transactionType').value = transaction.type;
                    document.getElementById('transactionAmount').value = transaction.amount;
                    document.getElementById('paymentMode').value = transaction.payment_mode || 'cash';
                    document.getElementById('transactionDescription').value = transaction.description || '';
                    title.textContent = 'Edit Transaction';
                }
            } else {
                // Add mode
                if (partyId) {
                    const party = parties.find(p => p.id === partyId);
                    if (party) {
                        document.getElementById('transactionPartySearch').value = party.name;
                        document.getElementById('transactionParty').value = party.id;
                        // Set intelligent default transaction type
                        if (party.type === 'sundry_debtors') {
                            document.getElementById('transactionType').value = 'credit';
                        } else {
                            document.getElementById('transactionType').value = 'debit';
                        }
                    }
                }
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                title.textContent = 'Add Transaction';
            }
            
            document.getElementById('transactionModal').classList.add('active');
            setTimeout(() => document.getElementById('transactionPartySearch').focus(), 100);
        }

        // Edit party
        function editParty(partyId) {
            openPartyModal(partyId);
        }

        // Edit transaction
        function editTransaction(transactionId) {
            openTransactionModal(null, transactionId);
        }

        // Delete party
        async function deleteParty(partyId, partyName) {
            showLoading();
            
            try {
                // First delete all transactions for this party
                const { error: transactionsError } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('party_id', partyId)
                    .eq('user_id', currentUser.id);
                
                if (transactionsError) throw transactionsError;
                
                // Then delete the party
                const { error: partyError } = await supabase
                    .from('parties')
                    .delete()
                    .eq('id', partyId)
                    .eq('user_id', currentUser.id);
                
                if (partyError) throw partyError;
                
                showToast(`Party "${partyName}" deleted successfully`, 'success');
                
                // Refresh data
                await refreshData();
                showDashboard();
                
            } catch (error) {
                console.error('Delete party error:', error);
                showToast('Failed to delete party: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        // Delete transaction
        async function deleteTransaction(transactionId) {
            showLoading();
            
            try {
                // 1. Get the transaction details
                const { data: transaction, error: fetchError } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('id', transactionId)
                    .single();

                if (fetchError) throw fetchError;

                // 2. Get party details
                const { data: party, error: partyError } = await supabase
                    .from('parties')
                    .select('*')
                    .eq('id', transaction.party_id)
                    .single();

                if (partyError) throw partyError;

                // 3. Calculate new balance by reversing the transaction
                let newBalance = party.balance || 0;
                
                if (party.type === 'sundry_debtors') {
                    // For debtors: reverse the credit/debit effect
                    if (transaction.type === 'credit') {
                        newBalance = newBalance - transaction.amount;
                    } else {
                        newBalance = newBalance + transaction.amount;
                    }
                } else {
                    // For creditors: reverse the credit/debit effect
                    if (transaction.type === 'credit') {
                        newBalance = newBalance + transaction.amount;
                    } else {
                        newBalance = newBalance - transaction.amount;
                    }
                }

                // 4. Update party balance in database
                const { error: updateError } = await supabase
                    .from('parties')
                    .update({
                        balance: newBalance,
                        last_activity: new Date().toISOString()
                    })
                    .eq('id', transaction.party_id);

                if (updateError) throw updateError;

                // 5. Delete the transaction
                const { error: deleteError } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('id', transactionId);

                if (deleteError) throw deleteError;

                showToast('Transaction deleted successfully', 'success');

                // 6. Refresh the view
                if (currentParty && currentParty.id === transaction.party_id) {
                    await viewPartyDetails(currentParty.id);
                } else {
                    await refreshData();
                    showDashboard();
                }

            } catch (error) {
                console.error('Delete transaction error:', error);
                showToast('Failed to delete transaction: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        // Handle party form submission
        async function handlePartySubmit(e) {
            e.preventDefault();
            
            const partyId = e.target.dataset.editing;
            const partyData = {
                name: document.getElementById('partyName').value.trim(),
                type: document.getElementById('partyType').value,
                balance: parseFloat(document.getElementById('initialBalance').value) || 0,
                gstin: document.getElementById('partyGSTIN').value.trim() || null,
                address: document.getElementById('partyAddress').value.trim() || null,
                email: document.getElementById('partyEmail').value.trim() || null,
                phone: document.getElementById('partyPhone').value.trim() || null,
                notes: document.getElementById('partyNotes').value.trim() || null,
                status: 'active',
                user_id: currentUser.id
            };

            if (!partyData.name) {
                showToast('Party name is required', 'error');
                document.getElementById('partyName').focus();
                return;
            }

            showLoading();
            
            try {
                if (partyId) {
                    // Update existing party
                    const { error } = await supabase
                        .from('parties')
                        .update(partyData)
                        .eq('id', partyId);
                    
                    if (error) throw error;
                    showToast('Party updated successfully', 'success');
                } else {
                    // Create new party
                    const { error } = await supabase
                        .from('parties')
                        .insert([partyData]);
                    
                    if (error) throw error;
                    showToast('Party created successfully', 'success');
                }
                
                closeModal('party');
                await refreshData();
                
                // If we're on a party details page, refresh it
                if (currentParty && partyId === currentParty.id) {
                    await viewPartyDetails(partyId);
                }
                
            } catch (error) {
                showToast('Failed to save party: ' + error.message, 'error');
                console.error('Party save error:', error);
            }
            
            hideLoading();
        }

        // Handle transaction form submission
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            const transactionId = document.getElementById('transactionId').value;
            const partyId = document.getElementById('transactionParty').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const date = document.getElementById('transactionDate').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const description = document.getElementById('transactionDescription').value.trim();

            if (!partyId) {
                showToast('Please select a party', 'error');
                document.getElementById('transactionPartySearch').focus();
                return;
            }

            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                document.getElementById('transactionAmount').focus();
                return;
            }

            showLoading();
            
            try {
                if (transactionId) {
                    // Edit existing transaction
                    await updateTransaction(transactionId, partyId, amount, type, date, paymentMode, description);
                } else {
                    // Create new transaction
                    await createTransaction(partyId, amount, type, date, paymentMode, description);
                }
                
                closeModal('transaction');
                await refreshData();
                
                // If we're on a party details page for this party, refresh it
                if (currentParty && currentParty.id === partyId) {
                    await viewPartyDetails(partyId);
                }
                
            } catch (error) {
                showToast('Failed to save transaction: ' + error.message, 'error');
                console.error('Transaction error:', error);
            }
            
            hideLoading();
        }

        // Create new transaction
        async function createTransaction(partyId, amount, type, date, paymentMode, description) {
            // Get current party balance
            const { data: party, error: partyError } = await supabase
                .from('parties')
                .select('balance, type')
                .eq('id', partyId)
                .single();
            
            if (partyError) throw partyError;
            
            // Calculate new balance based on transaction type and party type
            const currentBalance = party.balance || 0;
            let newBalance;
            
            if (party.type === 'sundry_debtors') {
                // For debtors: credit increases balance (they owe more), debit decreases (payment received)
                newBalance = type === 'credit' ? currentBalance + amount : currentBalance - amount;
            } else {
                // For creditors: credit decreases balance (we owe less), debit increases (we owe more)
                newBalance = type === 'credit' ? currentBalance - amount : currentBalance + amount;
            }
            
            // Create transaction
            const transactionData = {
                party_id: partyId,
                amount: amount,
                type: type,
                date: date,
                payment_mode: paymentMode,
                description: description || null,
                previous_balance: currentBalance,
                new_balance: newBalance,
                user_id: currentUser.id
            };
            
            const { error: transactionError } = await supabase
                .from('transactions')
                .insert([transactionData]);
            
            if (transactionError) throw transactionError;
            
            // Update party balance
            await supabase
                .from('parties')
                .update({
                    balance: newBalance,
                    last_activity: new Date().toISOString()
                })
                .eq('id', partyId);
            
            showToast('Transaction added successfully', 'success');
        }

        // Update existing transaction
        async function updateTransaction(transactionId, partyId, amount, type, date, paymentMode, description) {
            // Get the original transaction
            const { data: oldTransaction, error: fetchError } = await supabase
                .from('transactions')
                .select('*')
                .eq('id', transactionId)
                .single();
            
            if (fetchError) throw fetchError;
            
            // If party changed, we need to handle differently
            if (oldTransaction.party_id !== partyId) {
                // Remove from old party
                const { data: oldParty, error: oldPartyError } = await supabase
                    .from('parties')
                    .select('balance, type')
                    .eq('id', oldTransaction.party_id)
                    .single();
                
                if (oldPartyError) throw oldPartyError;
                
                // Reverse old transaction from old party
                let reversedBalance = oldParty.balance || 0;
                if (oldParty.type === 'sundry_debtors') {
                    reversedBalance = oldTransaction.type === 'credit' 
                        ? reversedBalance - oldTransaction.amount 
                        : reversedBalance + oldTransaction.amount;
                } else {
                    reversedBalance = oldTransaction.type === 'credit' 
                        ? reversedBalance + oldTransaction.amount 
                        : reversedBalance - oldTransaction.amount;
                }
                
                await supabase
                    .from('parties')
                    .update({ balance: reversedBalance })
                    .eq('id', oldTransaction.party_id);
            }
            
            // Delete old transaction
            await supabase
                .from('transactions')
                .delete()
                .eq('id', transactionId);
            
            // Create new transaction
            await createTransaction(partyId, amount, type, date, paymentMode, description);
            
            showToast('Transaction updated successfully', 'success');
        }

        // Close modal
        function closeModal(type) {
            if (type === 'party') {
                document.getElementById('partyModal').classList.remove('active');
            } else if (type === 'transaction') {
                document.getElementById('transactionModal').classList.remove('active');
            } else if (type === 'confirmation') {
                document.getElementById('confirmationModal').classList.remove('active');
            }
            
            // Return focus to previous element
            if (currentFocusedElement) {
                currentFocusedElement.focus();
            }
        }

        // Refresh all data
        async function refreshData() {
            showLoading();
            try {
                await Promise.all([
                    loadParties(),
                    loadTransactions()
                ]);
                
                if (currentParty) {
                    await viewPartyDetails(currentParty.id);
                } else {
                    await showDashboard();
                }
                
                showToast('Data refreshed successfully', 'success');
            } catch (error) {
                showToast('Failed to refresh data: ' + error.message, 'error');
            }
            hideLoading();
        }

        // Setup real-time subscription
        function setupRealtimeSubscription() {
            // Subscribe to parties changes
            supabase
                .channel('parties-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'parties',
                        filter: `user_id=eq.${currentUser.id}`
                    }, 
                    async () => {
                        await loadParties();
                        if (currentParty) {
                            currentParty = parties.find(p => p.id === currentParty.id);
                        }
                    }
                )
                .subscribe();

            // Subscribe to transactions changes
            supabase
                .channel('transactions-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'transactions',
                        filter: `user_id=eq.${currentUser.id}`
                    }, 
                    async () => {
                        await loadTransactions();
                        if (currentParty) {
                            await loadPartyTransactions(currentParty.id);
                            if (document.querySelector('.transactions-list')) {
                                document.querySelector('.transactions-list').innerHTML = renderPartyTransactions();
                            }
                        }
                    }
                )
                .subscribe();
        }

        // Helper functions
        function formatCurrency(amount) {
            const absAmount = Math.abs(amount);
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(absAmount);
        }
        
        function formatCurrencyNoSymbol(amount) {
            const absAmount = Math.abs(amount);
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(absAmount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Toast function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                </div>
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Add show class after a small delay
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // Expose functions to global scope
        window.showDashboard = showDashboard;
        window.showGraphs = showGraphs;
        window.showPrint = showPrint;
        window.viewPartyDetails = viewPartyDetails;
        window.editParty = editParty;
        window.openPartyModal = openPartyModal;
        window.openTransactionModal = openTransactionModal;
        window.editTransaction = editTransaction;
        window.confirmDeleteParty = confirmDeleteParty;
        window.confirmDeleteTransaction = confirmDeleteTransaction;
        window.deleteParty = deleteParty;
        window.deleteTransaction = deleteTransaction;
        window.showDebtors = showDebtors;
        window.showCreditors = showCreditors;
        window.showAllParties = showAllParties;
        window.filterPartiesByType = filterPartiesByType;
        window.filterParties = filterParties;
        window.closeModal = closeModal;
        window.refreshData = refreshData;
        window.updateGraphs = updateGraphs;
        window.generatePrintPreview = generatePrintPreview;
        window.exportToExcel = exportToExcel;
        window.printReport = printReport;
        window.selectSuggestion = selectSuggestion;
        window.changeReportType = changeReportType;
        
        // Add window resize handler for charts
        window.addEventListener('resize', function() {
            if (charts.balanceChart || charts.transactionChart) {
                setTimeout(updateGraphs, 300);
            }
        });
    </script>
</body>
</html>
